<html>
  <head>
    <title>QRCODE</title>
    <style type="text/css"></style>
    <script type="text/javascript" src="grid.js"></script>
    <script type="text/javascript" src="version.js"></script>
    <script type="text/javascript" src="detector.js"></script>
    <script type="text/javascript" src="formatinf.js"></script>
    <script type="text/javascript" src="errorlevel.js"></script>
    <script type="text/javascript" src="bitmat.js"></script>
    <script type="text/javascript" src="datablock.js"></script>
    <script type="text/javascript" src="bmparser.js"></script>
    <script type="text/javascript" src="datamask.js"></script>
    <script type="text/javascript" src="rsdecoder.js"></script>
    <script type="text/javascript" src="gf256poly.js"></script>
    <script type="text/javascript" src="gf256.js"></script>
    <script type="text/javascript" src="decoder.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
    <script type="text/javascript" src="findpat.js"></script>
    <script type="text/javascript" src="alignpat.js"></script>
    <script type="text/javascript" src="databr.js"></script>

    <style>
      #qr-canvas {
        display: none;
      }
      #result {
        font-size: 1.5em;
      }
      #location {
        font-size: 1.5em;
      }
    </style>
  </head>

  <body>
    <div id="main">
      <div id="mainbody">
        <table class="tsel" border="0" width="100%">
          <tr>
            <td valign="top" align="center" width="50%">
              <table class="tsel" border="0">
                <tr>
                  <td colspan="2" align="center">
                    <div id="outdiv"></div>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td colspan="3" align="center">
              <img src="" />
            </td>
          </tr>
          <tr>
            <td colspan="3" align="center">
              <div id="result"></div>
              <div id="location"></div>
            </td>
          </tr>
        </table>
      </div>
      &nbsp;
      <div id="footer">
        <h5 align="center"></h5>
      </div>
    </div>
    <canvas id="qr-canvas" width="800" height="600"></canvas>
    <script>
      var gCtx = null;
      var gCanvas = null;
      var c = 0;
      var stype = 0;
      var gUM = false;
      var webkit = false;
      var moz = false;
      var v = null;

      var vidhtml = '<video id="v" autoplay></video>';

      function scb(position) {
        document.getElementById("location").innerHTML = `<p>${
          position.coords.latitude
        },   ${position.coords.longitude}, ${position.coords.altitude}</p>`;
      }
      function fcb(position) {
        document.getElementById("location").innerHTML = `error`;
      }
      setInterval(initGeo, 5000);
      function initGeo() {
        if (navigator && navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(scb, fcb);
        } else {
          document.getElementById(
            "location"
          ).innerHTML = `Geolocation is not supported`;
        }
      }
      function initCanvas(w, h) {
        gCanvas = document.getElementById("qr-canvas");
        gCanvas.style.width = w + "px";
        gCanvas.style.height = h + "px";
        gCanvas.width = w;
        gCanvas.height = h;
        gCtx = gCanvas.getContext("2d");
        gCtx.clearRect(0, 0, w, h);
      }

      function captureToCanvas() {
        if (stype != 1) return;
        if (gUM) {
          try {
            gCtx.drawImage(v, 0, 0);
            try {
              qrcode.decode();
            } catch (e) {
              console.log(e);
              setTimeout(captureToCanvas, 500);
            }
          } catch (e) {
            console.log(e);
            setTimeout(captureToCanvas, 500);
          }
        }
      }

      function htmlEntities(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function read(a) {
        var html = "<br>";
        if (a.indexOf("http://") === 0 || a.indexOf("https://") === 0)
          html += "<a target='_blank' href='" + a + "'>" + a + "</a><br>";
        html += "<b>" + htmlEntities(a) + "</b><br><br>";
        document.getElementById("result").innerHTML = html;
      }

      function isCanvasSupported() {
        var elem = document.createElement("canvas");
        return !!(elem.getContext && elem.getContext("2d"));
      }
      function success(stream) {
        v.srcObject = stream;
        v.play();

        gUM = true;
        setTimeout(captureToCanvas, 500);
      }

      function error(error) {
        gUM = false;
        return;
      }

      function load() {
        if (isCanvasSupported() && window.File && window.FileReader) {
          initCanvas(800, 600);
          qrcode.callback = read;
          document.getElementById("mainbody").style.display = "inline";
          setwebcam();
        } else {
          document.getElementById("mainbody").style.display = "inline";
          document.getElementById("mainbody").innerHTML =
            '<p id="mp1">QR code scanner for HTML5 capable browsers</p><br>' +
            '<br><p id="mp2">sorry your browser is not supported</p><br><br>' +
            '<p id="mp1">try <a href="http://www.mozilla.com/firefox"><img src="firefox.png"/></a> or <a href="http://chrome.google.com"><img src="chrome_logo.gif"/></a> or <a href="http://www.opera.com"><img src="Opera-logo.png"/></a></p>';
        }
      }
      function setwebcam() {
        var options = true;
        if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
          try {
            navigator.mediaDevices.enumerateDevices().then(function(devices) {
              devices.forEach(function(device) {
                if (device.kind === "videoinput") {
                  if (device.label.toLowerCase().search("back") > -1)
                    options = {
                      deviceId: { exact: device.deviceId },
                      facingMode: "environment"
                    };
                }
                console.log(
                  device.kind + ": " + device.label + " id = " + device.deviceId
                );
              });
              setwebcam2(options);
            });
          } catch (e) {
            console.log(e);
          }
        } else {
          console.log("no navigator.mediaDevices.enumerateDevices");
          setwebcam2(options);
        }
      }

      function setwebcam2(options) {
        console.log(options);
        document.getElementById("result").innerHTML = "- scanning -";
        if (stype == 1) {
          setTimeout(captureToCanvas, 500);
          return;
        }
        var n = navigator;
        document.getElementById("outdiv").innerHTML = vidhtml;
        v = document.getElementById("v");

        if (n.mediaDevices.getUserMedia) {
          n.mediaDevices
            .getUserMedia({ video: options, audio: false })
            .then(function(stream) {
              success(stream);
            })
            .catch(function(error) {
              error(error);
            });
        } else if (n.getUserMedia) {
          webkit = true;
          n.getUserMedia({ video: options, audio: false }, success, error);
        } else if (n.webkitGetUserMedia) {
          webkit = true;
          n.webkitGetUserMedia(
            { video: options, audio: false },
            success,
            error
          );
        }
        stype = 1;
        setTimeout(captureToCanvas, 500);
      }

      // function setimg() {
      //   document.getElementById("result").innerHTML = "";
      //   if (stype == 2) return;
      //   document.getElementById("qrimg").style.opacity = 1.0;
      //   document.getElementById("webcamimg").style.opacity = 0.2;
      //   var qrfile = document.getElementById("qrfile");
      //   qrfile.addEventListener("dragenter", dragenter, false);
      //   qrfile.addEventListener("dragover", dragover, false);
      //   qrfile.addEventListener("drop", drop, false);
      //   stype = 2;
      // }
      load();
    </script>
  </body>
</html>
